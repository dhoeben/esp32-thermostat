sensor:
  # Temperature & humidity sensor
  - platform: sht4x
    i2c_id: i2c_bus
    address: 0x44
    temperature:
      id: temperature
      name: "Thermostat Temperature"
      icon: mdi:thermometer
      accuracy_decimals: 2
    humidity:
      id: humidity
      name: "Thermostat Humidity"
      icon: mdi:water-percent
      accuracy_decimals: 1
    update_interval: never

  - platform: template
    id: temperature_rounded
    name: "Temperature Rounded"
    internal: true
    update_interval: 10s
    lambda: |-
      if (isnan(id(temperature).state)) return NAN;
      return roundf(id(temperature).state);

  - platform: template
    id: humidity_rounded
    name: "Humidity rounded"
    internal: true
    lambda: |-
      if (isnan(id(humidity).state)) return NAN;
      return round(id(humidity).state);
    update_interval: 120s
    accuracy_decimals: 0

  #Rotary switch
  - platform: rotary_encoder
    id: encoder
    name: "Encoder Value"
    pin_a:
      number: !secret pin_enc_a
      mode:
        input: true
        pullup: true
    pin_b:
      number: !secret pin_enc_b
      mode:
        input: true
        pullup: true
    resolution: 2
    internal: true
    debounce: 4ms
    filters:
      - debounce: 5ms
    on_clockwise:
      then:
        - logger.log: "Encoder rotated clockwise"
    on_anticlockwise:
      then:
        - logger.log: "Encoder rotated anticlockwise"


  #Battery sensor
  - platform: adc
    id: battery_voltage
    name: "Battery Voltage"
    pin: !secret pin_adc_in            
    attenuation: 11db
    power_supply: batt_ps
    internal: true
    update_interval: 12h
    samples: 8
    filters:
      - multiply: 11.0   # voltage divider correction (100k/10k)
      - throttle: 12h

  - platform: template
    id: battery_percent
    name: "Battery Level"
    unit_of_measurement: "%"
    update_interval: 12h
    lambda: |-
      const float v = id(battery_voltage).state;
      const float v_empty = 2.20f;
      const float v_full  = 3.30f;
      float p = (v - v_empty) / (v_full - v_empty) * 100.0f;
      if (p < 0) p = 0;
      if (p > 100) p = 100;
      return p;
    icon: mdi:battery

  
  # Home Assistant
  - platform: homeassistant
    name: "HA Set Temperature"
    entity_id: !secret climate_entity
    internal: true
    attribute: temperature
    id: ha_set_temperature